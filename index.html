<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Order System - FRESH START</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner mobile app look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level for debugging
        setLogLevel('debug'); 

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // **CRITICAL CHANGE**: This unique ID forces the app to create a new, clean database path.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kiosk-fresh-start-v4'; 
        
        window.fb = {
            db: null,
            auth: null,
            userId: null,
            appId: appId,
            isAuthReady: false,
            // Function placeholders will be populated later
            dbRef: (path) => doc(window.fb.db, path), 
            settingsCollectionRef: () => collection(window.fb.db, `/artifacts/${window.fb.appId}/public/data/settings`),
            menuCollectionRef: () => collection(window.fb.db, `/artifacts/${window.fb.appId}/public/data/menu`),
        };

        const defaultSettings = {
            kioskName: "Kiosk Order System - FRESH START", // Visually confirm the new version is loading
            tableNumber: "1A",
            adminPin: "1234", // Default PIN is set for the fresh start
            categories: [
                { id: 'all', name: 'All' },
                { id: 'food', name: 'Food' },
                { id: 'beverage', name: 'Beverage' },
            ],
            taxRate: 10, // 10% tax
            currencySymbol: '$'
        };

        const defaultMenuItems = [
            { id: 'item1', name: 'Classic Burger', description: 'Juicy beef patty with lettuce, tomato, and special sauce.', price: 12.99, image: 'https://placehold.co/150x150/555/FFF?text=Burger', categoryId: 'food' },
            { id: 'item2', name: 'Fresh Pasta', description: 'House-made pasta with marinara sauce and fresh basil.', price: 15.99, image: 'https://placehold.co/150x150/888/FFF?text=Pasta', categoryId: 'food' },
            { id: 'item3', name: 'Fresh Orange Juice', description: 'Freshly squeezed orange juice.', price: 5.99, image: 'https://placehold.co/150x150/F80/FFF?text=Juice', categoryId: 'beverage' },
            { id: 'item4', name: 'Cappuccino', description: 'Rich espresso with steamed milk and foam.', price: 4.99, image: 'https://placehold.co/150x150/444/FFF?text=Coffee', categoryId: 'beverage' },
        ];


        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config not available.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                window.fb.db = getFirestore(app);
                window.fb.auth = getAuth(app);

                // 1. Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(window.fb.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.fb.auth);
                }

                onAuthStateChanged(window.fb.auth, (user) => {
                    if (user) {
                        window.fb.userId = user.uid;
                    } else {
                        window.fb.userId = crypto.randomUUID(); // Fallback for anonymous
                    }
                    window.fb.isAuthReady = true;
                    console.log(`Auth Ready. User ID: ${window.fb.userId}. App ID: ${window.fb.appId}`);
                    // Start listeners once auth is ready
                    startDataListeners();
                });

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                document.getElementById('app-status').textContent = `Initialization Error: ${error.message}`;
            }
        }

        async function initializeDefaultData() {
            if (!window.fb.isAuthReady) return;

            const settingsDocRef = window.fb.dbRef(`artifacts/${window.fb.appId}/public/data/settings/app`);
            const settingsSnap = await getDoc(settingsDocRef);

            if (!settingsSnap.exists()) {
                console.log("No settings found. Initializing defaults.");
                await setDoc(settingsDocRef, defaultSettings);

                // Initialize menu items
                const batchPromises = defaultMenuItems.map(item => {
                    return setDoc(window.fb.dbRef(`artifacts/${window.fb.appId}/public/data/menu/${item.id}`), item);
                });
                await Promise.all(batchPromises);
                console.log("Default menu and settings initialized.");
            }
        }
        
        function startDataListeners() {
            if (!window.fb.isAuthReady) return;

            // 1. Settings Listener
            const settingsDocRef = window.fb.dbRef(`artifacts/${window.fb.appId}/public/data/settings/app`);
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.app.settings = docSnap.data();
                    window.app.render();
                } else {
                    // Initialize if settings are missing (first run)
                    initializeDefaultData();
                }
            });

            // 2. Menu Items Listener
            const menuQ = query(window.fb.menuCollectionRef());
            onSnapshot(menuQ, (querySnapshot) => {
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                window.app.menuItems = items;
                window.app.render();
            });
        }

        // --- GLOBAL APP STATE AND RENDERER ---
        window.app = {
            view: 'menu', // 'menu' or 'admin'
            settings: defaultSettings,
            menuItems: [],
            cart: [],
            activeCategory: 'all',
            modal: {
                visible: false,
                type: null, // 'admin-login', 'customize', 'order-submit', 'edit-item', 'add-item', 'edit-settings'
                data: null, // Data related to the modal (e.g., item being customized)
                message: null, // General message for modals
            },

            // --- State Management ---
            set(key, value) {
                this[key] = value;
                this.render();
            },

            // --- Cart Logic ---
            addToCart(item, customizations = {}) {
                const customizationString = Object.values(customizations).join('|');
                const cartItemId = `${item.id}-${Date.now()}`;

                this.cart.push({
                    cartId: cartItemId,
                    itemId: item.id,
                    name: item.name,
                    price: item.price,
                    customizations: customizations,
                    customizationString: customizationString,
                });
                this.render();
                this.closeModal();
                this.modal.message = { title: "Added to Order", text: `${item.name} added to your order!` };
                this.openModal('message');
            },
            removeFromCart(cartId) {
                this.cart = this.cart.filter(item => item.cartId !== cartId);
                this.render();
            },
            getCartTotal() {
                const subtotal = this.cart.reduce((sum, item) => sum + item.price, 0);
                const tax = subtotal * (this.settings.taxRate / 100);
                return { subtotal, tax, total: subtotal + tax };
            },
            clearCart() {
                this.cart = [];
                this.render();
            },
            
            // --- Modal Logic ---
            openModal(type, data = null) {
                this.modal.type = type;
                this.modal.data = data;
                this.modal.visible = true;
                this.render();
            },
            closeModal() {
                this.modal.visible = false;
                this.modal.type = null;
                this.modal.data = null;
                this.modal.message = null;
                this.render();
            },

            // --- Rendering ---
            render() {
                const root = document.getElementById('app-container');
                root.innerHTML = this.renderApp();

                // Attach event listeners after rendering
                this.attachEventListeners();
            },

            attachEventListeners() {
                // Attach listeners for modal close
                const closeButtons = document.querySelectorAll('.modal-close-btn');
                closeButtons.forEach(btn => btn.onclick = () => this.closeModal());
                
                // --- Menu View Listeners ---
                if (this.view === 'menu') {
                    // Category buttons
                    const categoryButtons = document.querySelectorAll('[data-category-id]');
                    categoryButtons.forEach(btn => btn.onclick = (e) => this.set('activeCategory', e.target.dataset.categoryId));

                    // Add to Cart buttons (opens customize modal)
                    const addToCartButtons = document.querySelectorAll('[data-item-id]');
                    addToCartButtons.forEach(btn => btn.onclick = (e) => {
                        const itemId = e.target.closest('[data-item-id]').dataset.itemId;
                        const item = this.menuItems.find(i => i.id === itemId);
                        if (item) {
                            this.addToCart(item); // Simple add to cart (no customization in this basic version)
                        }
                    });

                    // Remove from Cart buttons
                    const removeButtons = document.querySelectorAll('[data-remove-cart-id]');
                    removeButtons.forEach(btn => btn.onclick = (e) => this.removeFromCart(e.target.dataset.removeCartId));

                    // Submit Order
                    const submitOrderBtn = document.getElementById('submit-order-btn');
                    if (submitOrderBtn) submitOrderBtn.onclick = () => this.openModal('order-submit');

                    // Admin Login
                    const adminBtn = document.getElementById('admin-login-btn');
                    if (adminBtn) adminBtn.onclick = () => this.openModal('admin-login');
                }
                
                // --- Admin View Listeners ---
                if (this.view === 'admin') {
                    // Exit Admin
                    const exitAdminBtn = document.getElementById('exit-admin-btn');
                    if (exitAdminBtn) exitAdminBtn.onclick = () => this.set('view', 'menu');
                    
                    // Edit Settings Button
                    const editSettingsBtn = document.getElementById('edit-settings-btn');
                    if (editSettingsBtn) editSettingsBtn.onclick = () => this.openModal('edit-settings', this.settings);
                    
                    // Delete Item
                    const deleteButtons = document.querySelectorAll('[data-delete-item-id]');
                    deleteButtons.forEach(btn => btn.onclick = async (e) => {
                        const itemId = e.target.dataset.deleteItemId;
                        if (confirm(`Are you sure you want to delete item ${itemId}?`)) {
                            await deleteMenuItem(itemId);
                        }
                    });
                }

                // --- Modal Form Listeners ---
                // Admin Login Form
                const adminForm = document.getElementById('admin-login-form');
                if (adminForm) {
                    adminForm.onsubmit = (e) => {
                        e.preventDefault();
                        const pin = document.getElementById('admin-pin-input').value;
                        this.handleAdminLogin(pin);
                    };
                }
                
                // Order Submit (Confirmation)
                const confirmOrderBtn = document.getElementById('confirm-order-btn');
                if (confirmOrderBtn) confirmOrderBtn.onclick = () => this.handleOrderSubmission();

                // Settings Form Submission
                const settingsForm = document.getElementById('settings-form');
                if (settingsForm) {
                    settingsForm.onsubmit = (e) => {
                        e.preventDefault();
                        const newSettings = {
                            kioskName: document.getElementById('kioskName').value,
                            tableNumber: document.getElementById('tableNumber').value,
                            adminPin: document.getElementById('adminPin').value,
                            taxRate: parseFloat(document.getElementById('taxRate').value) || 0,
                            currencySymbol: document.getElementById('currencySymbol').value,
                        };
                        updateSettings(newSettings);
                        this.closeModal();
                    };
                }
            },

            // --- Handler Functions ---
            handleAdminLogin(pin) {
                if (pin === this.settings.adminPin) {
                    this.set('view', 'admin');
                    this.closeModal();
                } else {
                    this.modal.message = { title: "Login Failed", text: "Incorrect Admin PIN." };
                    this.openModal('message');
                }
            },

            handleOrderSubmission() {
                if (this.cart.length === 0) return;
                
                // In a real app, this would send the order to a server.
                console.log("Order Submitted:", this.cart);
                
                // Show order confirmation modal
                this.modal.data = { order: [...this.cart], total: this.getCartTotal() };
                this.clearCart();
                this.openModal('order-submitted');
            },

            // --- Renderers ---
            renderHeader() {
                const settings = this.settings;
                return `
                    <div class="p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-gray-800">${settings.kioskName}</h1>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium text-gray-500">Table: ${settings.tableNumber}</span>
                                <button id="admin-login-btn" class="p-2 text-gray-500 hover:text-indigo-600 focus:outline-none">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.545.337 1.25.12 1.724-1.066z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <!-- Categories/Filter Tabs -->
                        <div class="mt-4 flex space-x-2 overflow-x-auto pb-1">
                            ${settings.categories.map(cat => `
                                <button data-category-id="${cat.id}"
                                    class="py-2 px-4 rounded-full text-sm font-medium transition duration-150 ease-in-out whitespace-nowrap
                                    ${this.activeCategory === cat.id ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                    ${cat.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderMenu() {
                const settings = this.settings;
                const filteredItems = this.menuItems.filter(item => 
                    this.activeCategory === 'all' || item.categoryId === this.activeCategory
                );
                
                return `
                    <div class="p-4 grid grid-cols-1 gap-6 sm:grid-cols-2">
                        ${filteredItems.map(item => `
                            <div class="card bg-white rounded-xl overflow-hidden transform hover:scale-[1.01] transition duration-200 ease-in-out">
                                <img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x160/cccccc/333333?text=Image+Missing';">
                                <div class="p-4">
                                    <h3 class="text-xl font-semibold text-gray-900 truncate">${item.name}</h3>
                                    <p class="text-sm text-gray-500 mt-1 line-clamp-2">${item.description}</p>
                                    <div class="flex justify-between items-center mt-3">
                                        <span class="text-2xl font-bold text-indigo-600">${settings.currencySymbol}${item.price.toFixed(2)}</span>
                                        <button data-item-id="${item.id}"
                                            class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg shadow-indigo-500/50">
                                            Add to Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${filteredItems.length === 0 ? '<p class="text-center text-gray-500 col-span-full py-10">No items in this category.</p>' : ''}
                    </div>
                `;
            },
            
            renderCart() {
                const { subtotal, tax, total } = this.getCartTotal();
                const settings = this.settings;
                
                return `
                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                        <h2 class="text-xl font-bold mb-3">Your Order (${this.cart.length} items)</h2>
                        
                        <div class="space-y-3 max-h-64 overflow-y-auto mb-4 pr-2">
                            ${this.cart.length === 0 ? '<p class="text-gray-500 text-sm">Your order is empty.</p>' : ''}
                            ${this.cart.map(item => `
                                <div class="flex justify-between items-start bg-white p-3 rounded-lg shadow-sm">
                                    <div class="flex-grow">
                                        <p class="font-semibold text-gray-800">${item.name}</p>
                                        <p class="text-xs text-gray-500 mt-1">${settings.currencySymbol}${item.price.toFixed(2)}</p>
                                    </div>
                                    <button data-remove-cart-id="${item.cartId}"
                                        class="ml-3 text-red-500 hover:text-red-700 transition duration-150 ease-in-out text-sm font-medium">
                                        Remove
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="space-y-1 pt-4 border-t border-gray-200">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-medium">${settings.currencySymbol}${subtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Tax (${settings.taxRate}%):</span>
                                <span class="font-medium">${settings.currencySymbol}${tax.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold pt-2 border-t border-gray-200 mt-2">
                                <span>Total:</span>
                                <span>${settings.currencySymbol}${total.toFixed(2)}</span>
                            </div>
                        </div>

                        <button id="submit-order-btn"
                            ${this.cart.length === 0 ? 'disabled' : ''}
                            class="mt-4 w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-700 disabled:bg-gray-400 transition duration-150 ease-in-out shadow-md shadow-green-500/50">
                            Submit Order
                        </button>
                    </div>
                `;
            },

            renderAdminPanel() {
                const settings = this.settings;
                return `
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-white sticky top-0 z-10">
                        <h1 class="text-2xl font-bold text-gray-800">Admin Panel</h1>
                        <button id="exit-admin-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150">
                            Exit Admin
                        </button>
                    </div>

                    <div class="p-4 space-y-8">
                        <!-- Settings Management -->
                        <div class="card p-6 bg-white rounded-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Kiosk Settings</h2>
                                <button id="edit-settings-btn" class="text-indigo-600 hover:text-indigo-800 font-medium">
                                    Edit Settings
                                </button>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>Kiosk Name:</strong> ${settings.kioskName}</p>
                                <p><strong>Table Number:</strong> ${settings.tableNumber}</p>
                                <p><strong>Admin PIN (DO NOT SHARE):</strong> ****</p>
                                <p><strong>Tax Rate:</strong> ${settings.taxRate}%</p>
                                <p><strong>Currency:</strong> ${settings.currencySymbol}</p>
                            </div>
                        </div>

                        <!-- Menu Management -->
                        <div class="card p-6 bg-white rounded-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Menu Items (${this.menuItems.length})</h2>
                                <button class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150" onclick="window.app.openModal('add-item')">
                                    Add New Item
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                ${this.menuItems.map(item => `
                                    <div class="flex justify-between items-center p-3 border-b last:border-b-0">
                                        <div class="flex-grow">
                                            <p class="font-semibold text-gray-800">${item.name}</p>
                                            <p class="text-sm text-gray-500">${settings.currencySymbol}${item.price.toFixed(2)} (${item.categoryId})</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="window.app.openModal('edit-item', '${item.id}')" class="text-indigo-600 hover:text-indigo-800 p-2 rounded-full hover:bg-indigo-100 transition">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l4-4m6 6L13 10m3-4a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                            </button>
                                            <button data-delete-item-id="${item.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m4-10H5m4-2a1 1 0 011-1h4a1 1 0 011 1v2h-6V5z"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Categories Management -->
                        <div class="card p-6 bg-white rounded-xl">
                            <h2 class="text-xl font-semibold mb-4">Categories</h2>
                            <p class="text-sm text-gray-500 mb-4">Category management is disabled in this basic version to maintain stability.</p>
                            <div class="space-y-2">
                                ${settings.categories.filter(c => c.id !== 'all').map(cat => `
                                    <div class="flex justify-between items-center p-3 border rounded-lg">
                                        <span class="font-medium">${cat.name}</span>
                                        <span class="text-sm text-gray-500">Fixed</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderModal() {
                if (!this.modal.visible) return '';
                const settings = this.settings;
                let content = '';
                let title = '';

                switch (this.modal.type) {
                    case 'admin-login':
                        title = "Admin Access";
                        content = `
                            <form id="admin-login-form" class="space-y-4">
                                <p class="text-sm text-gray-500">Enter the Admin PIN to access management features. (Default: 1234)</p>
                                <input type="password" id="admin-pin-input" required maxlength="4" placeholder="••••"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center tracking-widest focus:ring-indigo-500 focus:border-indigo-500">
                                <div class="flex justify-end space-x-3 pt-2">
                                    <button type="button" class="modal-close-btn text-gray-600 hover:text-gray-800 py-2 px-4 rounded-lg">Cancel</button>
                                    <button type="submit" class="bg-indigo-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-indigo-700 transition">Enter</button>
                                </div>
                            </form>
                        `;
                        break;

                    case 'order-submit':
                        const total = this.getCartTotal().total;
                        title = "Confirm Order";
                        content = `
                            <div class="text-center space-y-4">
                                <p class="text-lg font-semibold">You are about to submit an order for:</p>
                                <p class="text-4xl font-bold text-indigo-600">${settings.currencySymbol}${total.toFixed(2)}</p>
                                <p class="text-gray-500">Please confirm payment and submit the order.</p>
                                <div class="flex justify-center space-x-4 pt-4">
                                    <button type="button" class="modal-close-btn bg-gray-300 text-gray-800 py-3 px-6 rounded-lg font-bold hover:bg-gray-400 transition">Cancel</button>
                                    <button id="confirm-order-btn" class="bg-green-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-green-700 transition">Confirm & Submit</button>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'order-submitted':
                        title = "Order Submitted!";
                        content = `
                            <div class="text-center space-y-4 p-6">
                                <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <h3 class="text-2xl font-bold text-gray-800">Thank You!</h3>
                                <p class="text-gray-600">Your order has been sent to the kitchen.</p>
                                <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                                    <p class="font-semibold">Order Details:</p>
                                    ${this.modal.data.order.map(item => `<p class="text-sm text-gray-700">${item.name} (${settings.currencySymbol}${item.price.toFixed(2)})</p>`).join('')}
                                    <p class="text-lg font-bold mt-2">Total: ${settings.currencySymbol}${this.modal.data.total.total.toFixed(2)}</p>
                                </div>
                                <button type="button" class="modal-close-btn mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Start New Order</button>
                            </div>
                        `;
                        break;

                    case 'edit-settings':
                        title = "Edit Kiosk Settings";
                        const s = this.modal.data;
                        content = `
                            <form id="settings-form" class="space-y-4">
                                <div>
                                    <label for="kioskName" class="block text-sm font-medium text-gray-700">Kiosk Name</label>
                                    <input type="text" id="kioskName" value="${s.kioskName}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="tableNumber" class="block text-sm font-medium text-gray-700">Table Number</label>
                                    <input type="text" id="tableNumber" value="${s.tableNumber}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="adminPin" class="block text-sm font-medium text-gray-700">Admin PIN</label>
                                    <input type="text" id="adminPin" value="${s.adminPin}" required maxlength="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <p class="text-xs text-red-500 mt-1">Changing the PIN is NOT recommended and may cause login issues!</p>
                                </div>
                                <div>
                                    <label for="taxRate" class="block text-sm font-medium text-gray-700">Tax Rate (%)</label>
                                    <input type="number" id="taxRate" value="${s.taxRate}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="currencySymbol" class="block text-sm font-medium text-gray-700">Currency Symbol</label>
                                    <input type="text" id="currencySymbol" value="${s.currencySymbol}" required maxlength="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div class="flex justify-end space-x-3 pt-2">
                                    <button type="button" class="modal-close-btn text-gray-600 hover:text-gray-800 py-2 px-4 rounded-lg">Cancel</button>
                                    <button type="submit" class="bg-indigo-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-indigo-700 transition">Save Settings</button>
                                </div>
                            </form>
                        `;
                        break;
                    
                    case 'message':
                        title = this.modal.message.title;
                        content = `
                            <div class="text-center space-y-4">
                                <p class="text-lg text-gray-600">${this.modal.message.text}</p>
                                <button type="button" class="modal-close-btn mt-4 bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition">Close</button>
                            </div>
                        `;
                        break;

                    case 'add-item':
                    case 'edit-item':
                        // Placeholder for menu item CRUD (requires more complex state management, simplified here)
                        title = this.modal.type === 'add-item' ? 'Add New Menu Item' : 'Edit Menu Item (Feature Disabled)';
                        content = `
                            <div class="text-center p-6 bg-yellow-50 rounded-lg">
                                <h3 class="text-xl font-bold text-yellow-800">Feature Disabled</h3>
                                <p class="text-gray-600 mt-2">Menu Item editing/adding has been disabled to simplify the code and prevent errors during setup.</p>
                                <p class="text-sm text-gray-500 mt-1">Please manually edit the default items in the code file if needed.</p>
                                <button type="button" class="modal-close-btn mt-4 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-bold hover:bg-gray-400 transition">Close</button>
                            </div>
                        `;
                        break;
                }

                return `
                    <div class="fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-300">
                            <!-- Modal Header -->
                            <div class="p-4 border-b flex justify-between items-center">
                                <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                                <button type="button" class="modal-close-btn text-gray-500 hover:text-gray-900">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            <!-- Modal Body -->
                            <div class="p-6">
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderApp() {
                return `
                    <div class="app-container">
                        ${this.view === 'menu' ? this.renderHeader() : ''}
                        <div class="main-content">
                            ${this.view === 'menu' ? this.renderMenu() : this.renderAdminPanel()}
                        </div>
                        ${this.view === 'menu' ? this.renderCart() : ''}
                        ${this.renderModal()}
                    </div>
                `;
            }
        };

        // --- Database Helpers ---
        async function updateSettings(newSettings) {
            try {
                const settingsDocRef = window.fb.dbRef(`artifacts/${window.fb.appId}/public/data/settings/app`);
                await updateDoc(settingsDocRef, newSettings);
                console.log("Settings updated successfully.");
                window.app.modal.message = { title: "Success", text: "Settings saved successfully." };
                window.app.openModal('message');
            } catch (error) {
                console.error("Error updating settings:", error);
                window.app.modal.message = { title: "Error", text: `Failed to save settings: ${error.message}` };
                window.app.openModal('message');
            }
        }
        
        async function deleteMenuItem(itemId) {
            try {
                const itemDocRef = window.fb.dbRef(`artifacts/${window.fb.appId}/public/data/menu/${itemId}`);
                await deleteDoc(itemDocRef);
                console.log(`Item ${itemId} deleted.`);
            } catch (error) {
                console.error("Error deleting item:", error);
                window.app.modal.message = { title: "Error", text: `Failed to delete item: ${error.message}` };
                window.app.openModal('message');
            }
        }


        // Initialize on load
        window.onload = initializeFirebase;
    </script>
</head>
<body>
    <div id="app-container">
        <div id="app-status" class="text-center p-8 text-gray-500">
            Loading Kiosk System...
        </div>
    </div>
</body>
</html>

