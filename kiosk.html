<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Kiosk Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        /* Style for full-screen PWA experience */
        .pwa-full-screen { min-height: 100vh; } 
    </style>
</head>
<body class="pwa-full-screen">

    <div id="app">
        <!-- Content loaded by JavaScript -->
    </div>

    <script>
        // --- 1. CONFIGURATION AND INITIAL STATE ---

        // Lucide icons setup (manual rendering for pure JS)
        function renderIcons() {
            lucide.createIcons();
        }

        const INITIAL_KIOSK_DATA = {
            menuItems: [
                { id: "1", name: "Classic Burger", description: "Juicy beef patty with lettuce, tomato, and special sauce", price: 12.99, category: "Food", image: "https://images.unsplash.com/photo-1550547660-d9450f859349?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxnb3VybWV0JTIwYnVyZ2VyfGVufDF8fHx8MTc2NDIxMDg2M3ww&ixlib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral", customizationOptions: [{ name: "Cheese", default: true }, { name: "Bacon", default: false }] },
                { id: "4", name: "Cappuccino", description: "Rich espresso with steamed milk and foam", price: 4.99, category: "Beverage", image: "https://images.unsplash.com/photo-1592663527359-cf6642f54cff?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHxjYXBtY2Npbm98ZW58MXx8fHwxNzY0MTkzNDI0fDA&lib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral", customizationOptions: [{ name: "Oat Milk", default: false }, { name: "Extra Shot", default: false }] },
                { id: "5", name: "Caesar Salad", description: "Crisp romaine, Parmesan cheese, croutons, and Caesar dressing.", price: 9.50, category: "Food", image: "https://images.unsplash.com/photo-1610444310574-d47f9f36f6d4?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxjYWVzYXIlMjBzYWxhZHxlbnwxfHx8fDE3MjEwNjQzNDR8MA&ixlib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral", customizationOptions: [{ name: "Chicken", default: false }, { name: "Extra Dressing", default: true }] },
                { id: "6", name: "Iced Tea", description: "Freshly brewed iced black tea, unsweetened.", price: 2.99, category: "Beverage", image: "https://images.unsplash.com/photo-1546761405-c32f05a9f939?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxpY2VkJTIwdGVhfGVufDF8fHx8MTcyMTA2NDM3M3ww&lib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral", customizationOptions: [{ name: "Lemon Slice", default: true }, { name: "Sweetener", default: false }] }
            ],
            categories: ["Food", "Beverage"],
            kioskName: "Local Kiosk System",
            adminPin: "12345",
            tableNumber: "1A",
        };

        let appState = {
            kioskData: JSON.parse(localStorage.getItem('kioskData')) || INITIAL_KIOSK_DATA,
            cart: [],
            isAdminMode: false,
            isCartOpen: false,
            orderSubmitted: false,
            activeCategory: 'All',
            activeAdminTab: 'Settings',
            modalOpen: false, // Used for Pin Dialog and Customization Modal
            modalType: null, // 'pin' or 'customize'
            itemToCustomize: null, // Item object for customization modal
            pinInput: '',
            pinError: false,
            itemToEdit: null, // Item object for Admin editing
            isItemEditorOpen: false,
        };

        // --- 2. STATE MANAGEMENT & DATA PERSISTENCE ---

        function saveKioskData() {
            // Save configuration data to local storage for persistence across reloads
            localStorage.setItem('kioskData', JSON.stringify(appState.kioskData));
        }

        function setState(newState) {
            Object.assign(appState, newState);
            renderApp();
        }

        function resetKioskData() {
            appState.kioskData = INITIAL_KIOSK_DATA;
            saveKioskData();
        }

        // --- 3. UTILITY FUNCTIONS ---

        function formatPrice(price) {
            return price.toFixed(2);
        }

        function getCartTotals() {
            const subtotal = appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const taxRate = 0.10;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            const totalItems = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
            return { subtotal, tax, total, taxRate, totalItems };
        }

        // --- 4. VIEWS (RENDERERS) ---

        // Basic Button Component HTML
        function Button({ children, onClick, variant = 'default', size = 'default', className = '', disabled = false, type = 'button' }) {
            let baseStyles = 'rounded-lg font-semibold transition duration-150 transform active:scale-95 flex items-center justify-center whitespace-nowrap';
            let variantStyles;
            let sizeStyles;

            switch (variant) {
                case 'outline':
                    variantStyles = 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100';
                    break;
                case 'ghost':
                    variantStyles = 'bg-transparent text-gray-700 hover:bg-gray-100';
                    break;
                case 'destructive':
                    variantStyles = 'bg-red-500 text-white hover:bg-red-600 shadow-md';
                    break;
                case 'secondary':
                    variantStyles = 'bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-sm';
                    break;
                case 'default':
                default:
                    variantStyles = 'bg-gray-800 text-white hover:bg-gray-700 shadow-md';
                    break;
            }

            switch (size) {
                case 'icon':
                    sizeStyles = 'w-9 h-9 p-2';
                    break;
                case 'sm':
                    sizeStyles = 'px-3 py-1.5 text-sm';
                    break;
                case 'lg':
                    sizeStyles = 'px-6 py-3 text-lg';
                    break;
                case 'default':
                default:
                    sizeStyles = 'px-4 py-2';
                    break;
            }

            return `<button type="${type}" onclick="${disabled ? '' : onClick}" class="${baseStyles} ${variantStyles} ${sizeStyles} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" ${disabled ? 'disabled' : ''}>${children}</button>`;
        }

        // Modal Component HTML
        function Modal({ children, title, onClose, className = '' }) {
            if (!appState.modalOpen && !appState.isItemEditorOpen) return '';

            const isItemEditor = appState.isItemEditorOpen;
            const closeHandler = isItemEditor ? 'closeItemEditor()' : onClose;
            const currentTitle = isItemEditor ? 'Edit Item' : title;

            return `
                <div class="fixed inset-0 bg-black bg-opacity-40 z-[99] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl transition-all duration-300 transform scale-100 ${className}">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-900">${currentTitle}</h3>
                            ${Button({
                                variant: 'ghost',
                                size: 'icon',
                                onClick: closeHandler,
                                children: '<i data-lucide="x" class="w-5 h-5"></i>'
                            })}
                        </div>
                        ${children}
                    </div>
                </div>
            `;
        }
        
        // --- ADMIN PANEL EDITOR ---
        function renderItemEditorModal() {
            const item = appState.itemToEdit || {
                id: (Date.now() + Math.random()).toString(),
                name: '',
                description: '',
                price: 0.00,
                category: appState.kioskData.categories[0] || 'Food',
                image: '',
                customizationOptions: [],
            };
            const isNew = !appState.kioskData.menuItems.find(i => i.id === item.id);
            const title = isNew ? "Add New Menu Item" : `Edit ${item.name || 'Item'}`;

            // Helper to handle input changes without full re-render on every key stroke (optimistic update needed)
            function updateTempItem(key, value) {
                appState.itemToEdit = {
                    ...(appState.itemToEdit || item),
                    [key]: value
                };
            }
            
            // Helper to get the current state of the item being edited (handles live edits)
            const getCurrentItem = () => appState.kioskData.menuItems.find(i => i.id === item.id) || appState.itemToEdit || item;

            function renderOptions() {
                const currentItem = getCurrentItem();
                const options = currentItem.customizationOptions || [];
                let html = options.map(opt => `
                    <div key="${opt.name}" class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border">
                        <span class="flex-1 text-gray-700">${opt.name}</span>
                        ${Button({
                            type: 'button',
                            variant: opt.default ? 'default' : 'outline',
                            size: 'sm',
                            className: 'text-xs',
                            onClick: `toggleOptionDefault('${item.id}', '${opt.name}')`,
                            children: opt.default ? 'Default/Included' : 'Optional/Add-on'
                        })}
                        ${Button({
                            type: 'button',
                            variant: 'destructive',
                            size: 'icon',
                            onClick: `removeOption('${item.id}', '${opt.name}')`,
                            children: '<i data-lucide="trash-2" class="w-4 h-4"></i>'
                        })}
                    </div>
                `).join('');

                // Input for new option (needs to be managed outside of this function's scope)
                html += `
                    <div class="flex space-x-2 pt-2">
                        <input type="text" id="newOptionName" placeholder="New option name (e.g., Ketchup, Oat Milk)"
                            class="flex-1 rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500" />
                        ${Button({
                            type: 'button',
                            variant: 'secondary',
                            onClick: `addOption('${item.id}')`,
                            children: '<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Add'
                        })}
                    </div>
                `;
                return html;
            }

            // Function to handle form submission
            function handleSubmit() {
                const form = document.getElementById('itemEditorForm');
                const formData = new FormData(form);
                const newItem = {
                    id: item.id,
                    name: formData.get('name'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')) || 0.00,
                    category: formData.get('category'),
                    image: formData.get('image'),
                    // Customization options are handled separately via appState.itemToEdit
                    customizationOptions: (appState.itemToEdit || item).customizationOptions || [] 
                };
                
                // Final save logic
                saveItem(newItem);
                closeItemEditor();
            }
            
            // Override the default Modal HTML structure to inject the form and event listeners
            return `
                <div class="fixed inset-0 bg-black bg-opacity-40 z-[99] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl transition-all duration-300 transform scale-100">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                            ${Button({
                                variant: 'ghost',
                                size: 'icon',
                                onClick: `closeItemEditor()`,
                                children: '<i data-lucide="x" class="w-5 h-5"></i>'
                            })}
                        </div>
                        
                        <form id="itemEditorForm" onsubmit="event.preventDefault(); handleSubmitItemEditor();" class="p-6 max-h-[75vh] overflow-y-auto">
                            <div class="space-y-4">
                                <label class="block">
                                    <span class="text-sm font-medium text-gray-700">Name</span>
                                    <input type="text" name="name" value="${item.name}" required
                                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500" />
                                </label>
                                <label class="block">
                                    <span class="text-sm font-medium text-gray-700">Description</span>
                                    <textarea name="description" required
                                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500">${item.description}</textarea>
                                </label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="block">
                                        <span class="text-sm font-medium text-gray-700">Price ($)</span>
                                        <input type="number" name="price" value="${item.price}" required step="0.01"
                                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500" />
                                    </label>
                                    <label class="block">
                                        <span class="text-sm font-medium text-gray-700">Category</span>
                                        <select name="category" required
                                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border bg-white focus:border-indigo-500">
                                            ${appState.kioskData.categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                        </select>
                                    </label>
                                </div>
                                <label class="block">
                                    <span class="text-sm font-medium text-gray-700">Image URL</span>
                                    <input type="url" name="image" value="${item.image}"
                                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500" />
                                </label>

                                <div class="pt-4 border-t border-gray-200">
                                    <h4 class="text-lg font-bold text-gray-800 mb-3">Customization Options (Ingredients)</h4>
                                    <div class="space-y-2 mb-4" id="customizationOptionsContainer">
                                        ${renderOptions()}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end space-x-3 border-t pt-4">
                                ${Button({ type: 'button', variant: 'outline', onClick: 'closeItemEditor()', children: 'Cancel' })}
                                ${Button({ type: 'submit', variant: 'default', children: '<i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Item' })}
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // Expose function for the form submit to call
        window.handleSubmitItemEditor = function() {
            const form = document.getElementById('itemEditorForm');
            const formData = new FormData(form);
            const item = appState.itemToEdit; // The base item (may be an existing one or a temporary new one)
            
            // Find the *actual* item in the menu or use the temporary state for options
            const currentOptions = appState.itemToEdit.customizationOptions || [];

            const newItem = {
                id: item.id,
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')) || 0.00,
                category: formData.get('category'),
                image: formData.get('image'),
                customizationOptions: currentOptions
            };
            
            let newItems;
            const index = appState.kioskData.menuItems.findIndex(i => i.id === newItem.id);
            if (index >= 0) {
                // Update existing item
                newItems = appState.kioskData.menuItems.map((i, idx) => (idx === index ? newItem : i));
            } else {
                // Add new item
                newItems = [...appState.kioskData.menuItems, newItem];
            }

            appState.kioskData.menuItems = newItems;
            saveKioskData();
            closeItemEditor();
        }

        window.openItemEditor = function(itemId = null) {
            appState.isItemEditorOpen = true;
            if (itemId) {
                appState.itemToEdit = appState.kioskData.menuItems.find(i => i.id === itemId);
                // Create a deep copy for customization editing in admin mode
                appState.itemToEdit = JSON.parse(JSON.stringify(appState.itemToEdit)); 
            } else {
                appState.itemToEdit = {
                    id: (Date.now() + Math.random()).toString(),
                    name: '',
                    description: '',
                    price: 0.00,
                    category: appState.kioskData.categories[0] || 'Food',
                    image: '',
                    customizationOptions: [],
                };
            }
            renderApp();
        }
        
        window.closeItemEditor = function() {
            appState.isItemEditorOpen = false;
            appState.itemToEdit = null;
            renderApp();
        }

        // Functions for customization management inside the admin editor
        window.toggleOptionDefault = function(itemId, optionName) {
            if (!appState.itemToEdit || appState.itemToEdit.id !== itemId) return;
            appState.itemToEdit.customizationOptions = appState.itemToEdit.customizationOptions.map(opt => 
                opt.name === optionName ? { ...opt, default: !opt.default } : opt
            );
            renderApp(); // Rerender to show updated option state
        }

        window.removeOption = function(itemId, optionName) {
            if (!appState.itemToEdit || appState.itemToEdit.id !== itemId) return;
            appState.itemToEdit.customizationOptions = appState.itemToEdit.customizationOptions.filter(opt => opt.name !== optionName);
            renderApp();
        }
        
        window.addOption = function(itemId) {
            if (!appState.itemToEdit || appState.itemToEdit.id !== itemId) return;
            const newOptionName = document.getElementById('newOptionName').value.trim();
            if (newOptionName && !appState.itemToEdit.customizationOptions.some(opt => opt.name === newOptionName)) {
                appState.itemToEdit.customizationOptions.push({ name: newOptionName, default: false });
                document.getElementById('newOptionName').value = ''; // Clear input
                renderApp();
            }
        }
        
        // --- ADMIN PANEL RENDERING ---

        function renderAdminSettingsTab() {
             const kiosk = appState.kioskData;
            
            function renderCategories() {
                let html = kiosk.categories.map(cat => `
                    <div key="${cat}" class="flex justify-between items-center bg-white p-3 rounded-lg border">
                        <span class="font-medium text-gray-700">${cat}</span>
                        ${Button({ variant: 'destructive', size: 'sm', onClick: `deleteCategory('${cat}')`, children: '<i data-lucide="trash-2" class="w-4 h-4"></i>' })}
                    </div>
                `).join('');

                html += `
                    <div class="flex space-x-2 pt-2">
                        <input type="text" id="newCategoryInput" placeholder="New category name"
                            class="flex-1 rounded-lg border-gray-300 p-3 border focus:border-indigo-500" />
                        ${Button({
                            variant: 'secondary',
                            onClick: `addCategory()`,
                            children: '<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Add Category'
                        })}
                    </div>
                `;
                return html;
            }

            return `
                <div class="p-4 space-y-6">
                    <h3 class="text-xl font-bold text-gray-800">General Settings</h3>
                    <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Kiosk Name</span>
                            <input type="text" id="kioskNameInput" value="${kiosk.kioskName}"
                                class="mt-1 block w-full rounded-lg border-gray-300 p-3 border focus:border-indigo-500" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Table Number Default</span>
                            <input type="text" id="tableNumberInput" value="${kiosk.tableNumber}"
                                class="mt-1 block w-full rounded-lg border-gray-300 p-3 border focus:border-indigo-500" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Admin PIN</span>
                            <input type="password" id="adminPinInput" value="${kiosk.adminPin}"
                                class="mt-1 block w-full rounded-lg border-gray-300 p-3 border focus:border-indigo-500" />
                        </label>
                        ${Button({ onClick: 'saveSettings()', className: 'w-full', children: 'Save Settings' })}
                        
                        <div class="pt-4 border-t border-gray-200">
                             ${Button({ onClick: 'handleResetData()', variant: 'destructive', className: 'w-full mt-2', children: '<i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> Reset to Default Data' })}
                            <p class="text-xs text-center text-red-500 mt-1">This will erase all current items and settings.</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 pt-4 border-t">Menu Categories</h3>
                    <div class="space-y-3">
                         ${renderCategories()}
                    </div>
                </div>
            `;
        }
        
        window.saveSettings = function() {
            const newKioskData = {
                ...appState.kioskData,
                kioskName: document.getElementById('kioskNameInput').value,
                tableNumber: document.getElementById('tableNumberInput').value,
                adminPin: document.getElementById('adminPinInput').value
            };
            setState({ kioskData: newKioskData });
            saveKioskData();
            console.log("Settings saved.");
        }
        
        window.handleResetData = function() {
            if (confirm("WARNING: Are you sure you want to reset ALL menu items and settings to the default template? This action is irreversible.")) {
                resetKioskData();
                renderApp();
            }
        }

        window.addCategory = function() {
            const newCategory = document.getElementById('newCategoryInput').value.trim();
            if (newCategory && !appState.kioskData.categories.includes(newCategory)) {
                appState.kioskData.categories.push(newCategory);
                document.getElementById('newCategoryInput').value = ''; // Clear input
                saveKioskData();
                renderApp();
            }
        }
        
        window.deleteCategory = function(catToDelete) {
             if (appState.kioskData.menuItems.some(item => item.category === catToDelete)) {
                alert(`Cannot delete category "${catToDelete}". Please move or delete all items in this category first.`);
                return;
            }
            appState.kioskData.categories = appState.kioskData.categories.filter(cat => cat !== catToDelete);
            saveKioskData();
            renderApp();
        }

        function renderAdminMenuItemsTab() {
            const groupedItems = appState.kioskData.menuItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) { acc[category] = []; }
                acc[category].push(item);
                return acc;
            }, {});

            let sections = Object.keys(groupedItems).map(category => `
                <section>
                    <h3 class="text-xl font-bold text-gray-700 mb-4">${category}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${groupedItems[category].map(item => `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden flex shadow-sm">
                                <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/FFFFFF?text=${item.name.slice(0, 1)}';" />
                                <div class="flex-grow p-3 flex flex-col justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-800">${item.name}</p>
                                        <p class="text-sm text-gray-600">$${formatPrice(item.price)}</p>
                                    </div>
                                    <div class="flex space-x-2 mt-2">
                                        ${Button({ variant: 'outline', size: 'sm', onClick: `openItemEditor('${item.id}')`, children: '<i data-lucide="pencil" class="w-4 h-4 mr-1"></i> Edit' })}
                                        ${Button({ variant: 'destructive', size: 'sm', onClick: `deleteItem('${item.id}')`, children: '<i data-lucide="trash-2" class="w-4 h-4"></i>' })}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `).join('');

            return `
                <div class="p-4 space-y-6">
                    ${Button({ onClick: 'openItemEditor()', className: 'w-full flex items-center justify-center', children: '<i data-lucide="plus-square" class="w-5 h-5 mr-2"></i> Add New Item' })}
                    <div class="space-y-8">
                        ${sections}
                    </div>
                </div>
            `;
        }
        
        window.deleteItem = function(itemId) {
            if (confirm("Are you sure you want to delete this item?")) {
                appState.kioskData.menuItems = appState.kioskData.menuItems.filter(item => item.id !== itemId);
                saveKioskData();
                renderApp();
            }
        }

        function renderAdminPanel() {
            const tabs = ['Settings', 'Menu Items'];
            const content = appState.activeAdminTab === 'Settings' ? renderAdminSettingsTab() : renderAdminMenuItemsTab();

            const header = `
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Admin Panel</h2>
                    ${Button({ variant: 'outline', onClick: 'exitAdminMode()', children: '<i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Exit Admin' })}
                </div>
                
                <div class="flex border-b border-gray-200">
                    ${tabs.map(tab => `
                        <button onclick="setAdminTab('${tab}')" class="px-6 py-3 font-semibold transition-colors ${appState.activeAdminTab === tab ? 'border-b-2 border-gray-800 text-gray-900' : 'text-gray-500 hover:text-gray-700'}">
                            ${tab}
                        </button>
                    `).join('')}
                </div>
            `;
            
            return `
                <div class="min-h-screen bg-neutral-100 p-4 sm:p-8">
                    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-xl">
                        ${header}
                        ${content}
                    </div>
                    ${appState.isItemEditorOpen ? renderItemEditorModal() : ''}
                </div>
            `;
        }

        window.setAdminTab = function(tab) {
            setState({ activeAdminTab: tab });
        }
        
        window.exitAdminMode = function() {
            setState({ isAdminMode: false });
        }
        
        // --- ORDER SUMMARY VIEW ---

        function renderOrderSummary() {
            const { subtotal, tax, total } = getCartTotals();
            const taxRate = 0.10;

            return `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 text-center space-y-6">
                        <div class="flex flex-col items-center">
                            <i data-lucide="check-circle" class="w-12 h-12 text-green-500"></i>
                            <h2 class="text-2xl font-bold text-gray-900 mt-2">Order Submitted</h2>
                        </div>
                        
                        <div class="bg-white border rounded-lg p-4 text-left space-y-3">
                            <h3 class="font-bold text-gray-700 border-b pb-2">Order Details</h3>
                            ${appState.cart.map(item => `
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span class="truncate pr-2">${item.name} x${item.quantity}</span>
                                    <span>$${formatPrice(item.price * item.quantity)}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="text-gray-700 text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span>$${formatPrice(subtotal)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tax (${(taxRate * 100).toFixed(0)}%):</span>
                                <span>$${formatPrice(tax)}</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-200 mt-2">
                                <span>Total:</span>
                                <span>$${formatPrice(total)}</span>
                            </div>
                        </div>

                        <p class="text-sm text-gray-500">
                            Your order will be delivered to Table <span class="font-bold text-gray-800">${appState.kioskData.tableNumber}</span>.
                        </p>
                        
                        ${Button({ onClick: 'startNewOrder()', className: 'w-full', size: 'lg', children: 'Start New Order' })}

                        <p class="text-xs text-gray-400">Please hand this device to staff for processing</p>
                    </div>
                </div>
            `;
        }
        
        window.startNewOrder = function() {
            setState({ orderSubmitted: false, cart: [] });
        }


        // --- PIN DIALOG ---
        function renderPinDialog() {
            if (!appState.modalOpen || appState.modalType !== 'pin') return '';

            return Modal({
                title: 'Admin Access',
                onClose: 'closeModal()',
                children: `
                    <div class="p-6 space-y-6">
                        <p class="text-gray-500 text-sm text-center">Enter PIN to access management features.</p>
                        
                        <input
                            type="password"
                            inputmode="numeric"
                            maxlength="${appState.kioskData.adminPin.length}"
                            value="${appState.pinInput}"
                            oninput="updatePinInput(this.value)"
                            placeholder="_____"
                            class="w-full text-center text-4xl tracking-widest p-4 rounded-lg border-2 focus:outline-none ${appState.pinError ? 'border-red-500' : 'border-gray-300 focus:border-indigo-500'}"
                        />

                        ${appState.pinError ? `
                            <p class="text-red-500 text-sm text-center flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Incorrect PIN.
                            </p>
                        ` : ''}
                        
                        <div class="flex justify-between gap-3 pt-2">
                            ${Button({ variant: 'outline', onClick: 'closeModal()', className: 'flex-1', children: 'Cancel' })}
                            ${Button({ onClick: 'submitPin()', disabled: appState.pinInput.length !== appState.kioskData.adminPin.length, className: 'flex-1', children: 'Enter' })}
                        </div>
                    </div>
                `
            });
        }
        
        window.openPinDialog = function() {
            setState({ modalOpen: true, modalType: 'pin', pinInput: '', pinError: false });
        }

        window.updatePinInput = function(value) {
            const pin = value.replace(/\D/g, ''); // Only digits
            if (pin.length <= appState.kioskData.adminPin.length) {
                appState.pinInput = pin;
                appState.pinError = false;
                renderApp(); // Force re-render for input value and error state
            }
        }
        
        window.submitPin = function() {
            if (appState.pinInput === appState.kioskData.adminPin) {
                setState({ modalOpen: false, modalType: null, pinInput: '', isAdminMode: true });
            } else {
                setState({ pinError: true, pinInput: '' });
            }
        }
        
        window.closeModal = function() {
            setState({ modalOpen: false, modalType: null, pinInput: '', pinError: false, itemToCustomize: null });
        }
        
        // --- CUSTOMIZATION DIALOG ---
        
        function renderCustomizationDialog() {
            if (!appState.modalOpen || appState.modalType !== 'customize' || !appState.itemToCustomize) return '';
            
            const item = appState.itemToCustomize;
            
            // Temporary state for the modal's internal logic
            let selectedOptions = item.tempSelectedOptions || (item.customizationOptions?.filter(opt => opt.default).map(opt => opt.name) || []);
            let quantity = item.tempQuantity || 1;
            
            const hasCustomizations = item.customizationOptions && item.customizationOptions.length > 0;
            const currentTotal = item.price * quantity;

            // Update temporary state and re-render the app
            window.toggleOption = function(name) {
                const index = selectedOptions.indexOf(name);
                if (index > -1) {
                    selectedOptions.splice(index, 1);
                } else {
                    selectedOptions.push(name);
                }
                item.tempSelectedOptions = selectedOptions;
                renderApp();
            }

            window.updateQuantity = function(delta) {
                const newQuantity = Math.max(1, quantity + delta);
                item.tempQuantity = newQuantity;
                renderApp();
            }

            window.handleAdd = function() {
                for (let i = 0; i < quantity; i++) {
                    addToCart(item, selectedOptions);
                }
                closeModal();
            }
            
            // Since this modal is generated by renderApp, we need to manually update temp state
            if (!item.tempSelectedOptions) item.tempSelectedOptions = selectedOptions;
            if (!item.tempQuantity) item.tempQuantity = quantity;

            return Modal({
                title: 'Customize Your Order',
                onClose: 'closeModal()',
                children: `
                    <div class="p-6 max-h-[70vh] overflow-y-auto">
                        <div class="flex space-x-4 mb-4 items-start">
                            <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/FFFFFF?text=${item.name.slice(0, 1)}';" />
                            <div class="flex-1">
                                <p class="font-bold text-lg text-gray-800">${item.name}</p>
                                <p class="text-gray-500 text-sm">$${formatPrice(item.price)}</p>
                                <p class="text-gray-600 text-sm mt-1">${item.description}</p>
                            </div>
                        </div>

                        <div class="space-y-3 pt-4 border-t border-gray-100">
                            <h4 class="text-md font-semibold text-gray-700">Options (Click to add/remove ingredients)</h4>
                            
                            ${!hasCustomizations ? `
                                <div class="text-center py-4 bg-gray-50 rounded-lg text-gray-500 text-sm">No customization options available.</div>
                            ` : `
                                <div class="space-y-2">
                                    ${item.customizationOptions.map(option => `
                                        <div onclick="toggleOption('${option.name.replace(/'/g, "\\'")}')" class="flex items-center justify-between cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                                            <span class="text-gray-700">${option.name}</span>
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition ${selectedOptions.includes(option.name) ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-gray-300'}">
                                                ${selectedOptions.includes(option.name) ? '<i data-lucide="check-circle" class="w-3 h-3 text-white fill-indigo-600"></i>' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>

                    <div class="p-6 pt-4 flex justify-between items-center gap-4 border-t">
                        <div class="flex items-center space-x-3">
                            ${Button({ 
                                variant: 'outline', 
                                size: 'icon', 
                                onClick: 'updateQuantity(-1)',
                                disabled: quantity <= 1,
                                children: '<i data-lucide="minus" class="w-4 h-4"></i>'
                            })}
                            <span class="text-lg font-bold w-8 text-center">${quantity}</span>
                            ${Button({ 
                                variant: 'outline', 
                                size: 'icon', 
                                onClick: 'updateQuantity(1)',
                                children: '<i data-lucide="plus" class="w-4 h-4"></i>'
                            })}
                        </div>
                        
                        ${Button({ 
                            onClick: 'handleAdd()',
                            className: 'w-full sm:w-auto',
                            size: 'lg',
                            children: `Add to Cart - $${formatPrice(currentTotal)}`
                        })}
                    </div>
                `
            });
        }
        
        // --- CART MANAGEMENT ---
        
        window.addToCart = function(item, selectedCustomizations) {
            const existingItem = appState.cart.find(
                (cartItem) =>
                    cartItem.id === item.id &&
                    JSON.stringify(cartItem.selectedCustomizations.sort()) === JSON.stringify(selectedCustomizations.sort())
            );
            
            if (existingItem) {
                appState.cart = appState.cart.map(cartItem =>
                    cartItem.cartItemId === existingItem.cartItemId
                        ? { ...cartItem, quantity: cartItem.quantity + 1 }
                        : cartItem
                );
            } else {
                appState.cart.push({
                    ...item,
                    quantity: 1,
                    selectedCustomizations,
                    cartItemId: Date.now().toString() + Math.random(),
                });
            }
            renderApp();
        }
        
        window.removeFromCart = function(cartItemId) {
            appState.cart = appState.cart.filter(item => item.cartItemId !== cartItemId);
            renderApp();
        }

        window.updateCartQuantity = function(cartItemId, quantity) {
            if (quantity <= 0) {
                removeFromCart(cartItemId);
                return;
            }
            appState.cart = appState.cart.map(item =>
                item.cartItemId === cartItemId
                    ? { ...item, quantity }
                    : item
            );
            renderApp();
        }

        window.openCart = function() { setState({ isCartOpen: true }); }
        window.closeCart = function() { setState({ isCartOpen: false }); }
        window.submitOrder = function() { setState({ orderSubmitted: true, isCartOpen: false }); }

        // --- CART DRAWER ---

        function renderCartDrawer() {
            if (!appState.isCartOpen) return '';
            
            const { subtotal, tax, total } = getCartTotals();
            const taxRate = 0.10;
            
            const cartItemsHtml = appState.cart.length === 0 ? `
                <div class="text-center text-gray-500 py-12">
                    <p class="text-lg">Your cart is empty</p>
                    <p class="text-sm mt-1">Add items from the menu.</p>
                </div>
            ` : appState.cart.map(item => `
                <div class="flex py-3 border-b border-gray-100">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-3 flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0AEC0/FFFFFF?text=${item.name.slice(0, 1)}';" />
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">$${formatPrice(item.price)} each</p>
                        ${item.selectedCustomizations && item.selectedCustomizations.length > 0 ? `
                            <p class="text-xs text-indigo-600 italic mt-1">Custom: ${item.selectedCustomizations.join(', ')}</p>
                        ` : ''}
                    </div>
                    
                    <div class="flex flex-col items-end justify-between ml-2">
                        ${Button({ 
                            variant: 'ghost', size: 'icon', className: 'text-red-500 hover:bg-red-50', 
                            onClick: `removeFromCart('${item.cartItemId}')`, 
                            children: '<i data-lucide="trash-2" class="w-4 h-4"></i>' 
                        })}
                        <div class="flex items-center space-x-1 mt-auto">
                            ${Button({ 
                                variant: 'outline', size: 'icon', className: 'w-6 h-6',
                                onClick: `updateCartQuantity('${item.cartItemId}', ${item.quantity - 1})`,
                                children: '<i data-lucide="minus" class="w-3 h-3"></i>'
                            })}
                            <span class="w-4 text-center text-sm font-medium text-gray-700">${item.quantity}</span>
                            ${Button({ 
                                variant: 'outline', size: 'icon', className: 'w-6 h-6',
                                onClick: `updateCartQuantity('${item.cartItemId}', ${item.quantity + 1})`,
                                children: '<i data-lucide="plus" class="w-3 h-3"></i>'
                            })}
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="fixed inset-0 z-50 transition-opacity">
                    <div class="absolute inset-0 bg-black bg-opacity-40" onclick="closeCart()"></div>
                    <div class="absolute right-0 top-0 bottom-0 bg-white w-full sm:max-w-md shadow-2xl flex flex-col transition-transform duration-300 translate-x-0">
                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-900">Your Order</h2>
                            ${Button({ variant: 'ghost', size: 'icon', onClick: 'closeCart()', children: '<i data-lucide="x" class="w-5 h-5"></i>' })}
                        </div>

                        <div class="flex-grow px-4 py-2 overflow-y-auto space-y-1">
                            ${cartItemsHtml}
                        </div>

                        <div class="p-4 border-t border-gray-200 bg-gray-50">
                            <div class="space-y-2 mb-4 text-gray-700 text-sm">
                                <div class="flex justify-between">
                                    <span>Subtotal:</span>
                                    <span>$${formatPrice(subtotal)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Tax (10%):</span>
                                    <span>$${formatPrice(tax)}</span>
                                </div>
                                <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-300">
                                    <span>Total:</span>
                                    <span>$${formatPrice(total)}</span>
                                </div>
                            </div>
                            
                            ${Button({ 
                                onClick: 'submitOrder()',
                                className: 'w-full',
                                size: 'lg',
                                disabled: appState.cart.length === 0,
                                children: 'Submit Order'
                            })}
                        </div>
                    </div>
                </div>
            `;
        }


        // --- MENU VIEW ---
        
        function renderMenuCard(item) {
            const hasCustomizations = item.customizationOptions && item.customizationOptions.length > 0;
            
            const handleCardClick = hasCustomizations 
                ? `openCustomization('${item.id}')` 
                : `addToCartById('${item.id}', [])`;
            
            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition-all duration-300 transform hover:shadow-xl cursor-pointer">
                    <div class="relative">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/9CA3AF/FFFFFF?text=${item.name.replace(/\s/g, '+')}';" />
                        <div class="absolute top-0 right-0 bg-gray-900 text-white px-3 py-1 rounded-bl-lg font-bold text-lg">
                            $${formatPrice(item.price)}
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-gray-800 mb-1">${item.name}</h3>
                        <p class="text-gray-500 text-sm flex-grow line-clamp-2">${item.description}</p>
                        
                        ${Button({ 
                            onClick: handleCardClick,
                            size: 'sm',
                            className: 'mt-3 w-full justify-center bg-indigo-600 hover:bg-indigo-700',
                            children: `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> ${hasCustomizations ? 'Customize & Add' : 'Add to Cart'}`
                        })}
                    </div>
                </div>
            `;
        }
        
        window.addToCartById = function(itemId, customizations) {
            const item = appState.kioskData.menuItems.find(i => i.id === itemId);
            if (item) addToCart(item, customizations);
        }
        
        window.openCustomization = function(itemId) {
            const item = appState.kioskData.menuItems.find(i => i.id === itemId);
            if (item) {
                // Initialize temporary state for the modal
                item.tempSelectedOptions = item.customizationOptions?.filter(opt => opt.default).map(opt => opt.name) || [];
                item.tempQuantity = 1;

                setState({ modalOpen: true, modalType: 'customize', itemToCustomize: item });
            }
        }

        function renderMenuView() {
            const allCategories = ['All', ...appState.kioskData.categories];
            
            const filteredItems = appState.kioskData.menuItems.filter(item => 
                appState.activeCategory === 'All' || item.category === appState.activeCategory
            );

            const groupedItems = filteredItems.reduce((acc, item) => {
                const category = item.category || 'Other';
                if (!acc[category]) { acc[category] = []; }
                acc[category].push(item);
                return acc;
            }, {});
            
            let menuContent = Object.keys(groupedItems).length === 0 ? `
                <div class="text-center p-12 text-gray-500">No items found in this category.</div>
            ` : Object.keys(groupedItems).map(category => `
                <section>
                    ${appState.activeCategory === 'All' ? `
                        <h2 class="text-2xl font-extrabold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">${category}</h2>
                    ` : ''}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${groupedItems[category].map(renderMenuCard).join('')}
                    </div>
                </section>
            `).join('<div class="h-12"></div>');


            return `
                <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    <!-- Category Navigation -->
                    <div class="flex space-x-2 border-b border-gray-200 pb-2 overflow-x-auto mb-6 sticky top-[5.25rem] bg-neutral-50 z-30">
                        ${allCategories.map(category => `
                            ${Button({
                                variant: appState.activeCategory === category ? 'default' : 'ghost',
                                onClick: `setCategory('${category}')`,
                                className: `text-sm whitespace-nowrap ${appState.activeCategory === category ? 'bg-gray-800 text-white' : 'text-gray-600 hover:bg-gray-200'}`,
                                children: category
                            })}
                        `).join('')}
                    </div>
                    
                    <div class="space-y-12">
                        ${menuContent}
                    </div>
                </div>
                ${renderPinDialog()}
                ${renderCustomizationDialog()}
            `;
        }

        window.setCategory = function(category) {
            setState({ activeCategory: category });
        }


        // --- MAIN APP RENDERER ---

        function renderMainApp() {
            const { totalItems } = getCartTotals();
            const kiosk = appState.kioskData;
            
            const header = `
                <header class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div class="flex flex-col">
                            <h1 class="text-2xl font-bold text-gray-900">${kiosk.kioskName}</h1>
                            ${kiosk.tableNumber ? `
                                <p class="text-gray-500 text-sm font-medium">
                                    Table: <span class="text-gray-800 font-semibold">${kiosk.tableNumber}</span>
                                </p>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            ${Button({
                                variant: 'outline',
                                size: 'icon',
                                onClick: 'openPinDialog()',
                                children: '<i data-lucide="settings" class="w-5 h-5"></i>'
                            })}
                            ${Button({
                                variant: 'default',
                                onClick: 'openCart()',
                                className: 'relative px-6 bg-gray-900 hover:bg-gray-700',
                                children: `
                                    <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                                    Cart
                                    ${totalItems > 0 ? `
                                        <span class="absolute -top-2 -right-2 bg-indigo-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold shadow-lg ring-2 ring-white">
                                            ${totalItems}
                                        </span>
                                    ` : ''}
                                `
                            })}
                        </div>
                    </div>
                </header>
            `;

            return `
                <div class="min-h-screen bg-neutral-50 font-sans">
                    ${header}
                    ${renderMenuView()}
                    ${renderCartDrawer()}
                </div>
            `;
        }

        function renderApp() {
            const appElement = document.getElementById('app');
            if (appState.orderSubmitted) {
                appElement.innerHTML = renderOrderSummary();
            } else if (appState.isAdminMode) {
                appElement.innerHTML = renderAdminPanel();
            } else {
                appElement.innerHTML = renderMainApp();
            }
            renderIcons(); // Re-render icons after changing innerHTML
        }
        
        // --- INITIALIZATION ---
        window.onload = function() {
            // Check for initial local storage data
            if (!localStorage.getItem('kioskData')) {
                saveKioskData(); // Save initial defaults if local storage is empty
            }
            renderApp();
        };
    </script>
</body>
</html>